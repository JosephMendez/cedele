!function(e,o,t,n){e(function(){e("body").on("blur",'input[name="zone_toll"]',function(o){let t=parseFloat(e(this).val())?parseFloat(e(this).val()):0;e(this).val(t)}),e("body").on("blur",'input[name="zone_extra_fee"]',function(o){let t=parseFloat(e(this).val())?parseFloat(e(this).val()):0;e(this).val(t)});var i=e(".wc-shipping-zone-methods"),s=e(".wc-shipping-zone-method-rows"),d=e(".wc-shipping-zone-method-save"),a=t.template("wc-shipping-zone-method-row"),h=t.template("wc-shipping-zone-method-row-blank"),c=Backbone.Model.extend({changes:{},logChanges:function(e){var o=this.changes||{};_.each(e.methods,function(e,t){o.methods=o.methods||{methods:{}},o.methods[t]=_.extend(o.methods[t]||{instance_id:t},e)}),void 0!==e.zone_name&&(o.zone_name=e.zone_name),void 0!==e.zone_toll&&(o.zone_toll=e.zone_toll),void 0!==e.zone_extra_fee&&(o.zone_extra_fee=e.zone_extra_fee),void 0!==e.zone_locations&&(o.zone_locations=e.zone_locations),void 0!==e.zone_postcodes&&(o.zone_postcodes=e.zone_postcodes),this.changes=o,this.trigger("change:methods")},save:function(){e.post(n+(n.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zone_methods_save_changes",{wc_shipping_zones_nonce:o.wc_shipping_zones_nonce,changes:this.changes,zone_id:o.zone_id},this.onSaveResponse,"json")},onSaveResponse:function(e,t){"success"===t&&(e.success?(e.data.zone_id!==o.zone_id&&(o.zone_id=e.data.zone_id,window.history.pushState&&window.history.pushState({},"","admin.php?page=wc-settings&tab=shipping&zone_id="+e.data.zone_id)),r.set("methods",e.data.methods),r.trigger("change:methods"),r.changes={},r.trigger("saved:methods")):window.alert(o.strings.save_failed))}}),l=Backbone.View.extend({rowTemplate:a,initialize:function(){this.listenTo(this.model,"change:methods",this.setUnloadConfirmation),this.listenTo(this.model,"saved:methods",this.clearUnloadConfirmation),this.listenTo(this.model,"saved:methods",this.render),s.on("change",{view:this},this.updateModelOnChange),s.on("sortupdate",{view:this},this.updateModelOnSort),e(window).on("beforeunload",{view:this},this.unloadConfirmation),d.on("click",{view:this},this.onSubmit),e(document.body).on("input change","#zone_name, #zone_locations, #zone_postcodes, #zone_toll, #zone_extra_fee",{view:this},this.onUpdateZone),e(document.body).on("click",".wc-shipping-zone-method-settings",{view:this},this.onConfigureShippingMethod),e(document.body).on("click",".wc-shipping-zone-add-method",{view:this},this.onAddShippingMethod),e(document.body).on("wc_backbone_modal_response",this.onConfigureShippingMethodSubmitted),e(document.body).on("wc_backbone_modal_response",this.onAddShippingMethodSubmitted),e(document.body).on("change",".wc-shipping-zone-method-selector select",this.onChangeShippingMethodSelector),e(document.body).on("click",".wc-shipping-zone-postcodes-toggle",this.onTogglePostcodes)},onUpdateZone:function(o){var t=o.data.view,n=t.model,i=e(this).val(),s=e(o.target).data("attribute"),d={};o.preventDefault(),d[s]=i,n.set(s,i),n.logChanges(d),t.render()},block:function(){e(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){e(this.el).unblock()},render:function(){var t=_.indexBy(this.model.get("methods"),"instance_id"),n=this.model.get("zone_name"),i=this.model.get("zone_toll"),s=this.model.get("zone_extra_fee"),d=this;e(".wc-shipping-zone-name").text(n||o.strings.default_zone_name),e(".wc-shipping-zone-toll").text(i||0),e(".wc-shipping-zone-extra-fee").text(s||0),this.$el.empty(),this.unblock(),_.size(t)?(t=_.sortBy(t,function(e){return parseInt(e.method_order,10)}),e.each(t,function(e,t){"yes"===t.enabled?t.enabled_icon='<span class="woocommerce-input-toggle woocommerce-input-toggle--enabled">'+o.strings.yes+"</span>":t.enabled_icon='<span class="woocommerce-input-toggle woocommerce-input-toggle--disabled">'+o.strings.no+"</span>",d.$el.append(d.rowTemplate(t));var n=d.$el.find('tr[data-id="'+t.instance_id+'"]');if(!t.has_settings){n.find(".wc-shipping-zone-method-title > a").replaceWith("<span>"+n.find(".wc-shipping-zone-method-title > a").text()+"</span>");var i=n.find(".wc-shipping-zone-method-delete");n.find(".wc-shipping-zone-method-title .row-actions").empty().html(i)}}),this.$el.find(".wc-shipping-zone-method-delete").on("click",{view:this},this.onDeleteRow),this.$el.find(".wc-shipping-zone-method-enabled a").on("click",{view:this},this.onToggleEnabled)):d.$el.append(h),this.initTooltips()},initTooltips:function(){e("#tiptip_holder").removeAttr("style"),e("#tiptip_arrow").removeAttr("style"),e(".tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:50})},onSubmit:function(e){e.data.view.block(),e.data.view.model.save(),e.preventDefault()},onDeleteRow:function(o){var t=o.data.view,n=t.model,i=_.indexBy(n.get("methods"),"instance_id"),s={},d=e(this).closest("tr").data("id");o.preventDefault(),delete i[d],s.methods=s.methods||{methods:{}},s.methods[d]=_.extend(s.methods[d]||{},{deleted:"deleted"}),n.set("methods",i),n.logChanges(s),t.render()},onToggleEnabled:function(o){var t=o.data.view,n=e(o.target),i=t.model,s=_.indexBy(i.get("methods"),"instance_id"),d=n.closest("tr").data("id"),a="yes"===n.closest("tr").data("enabled")?"no":"yes",h={};o.preventDefault(),s[d].enabled=a,h.methods=h.methods||{methods:{}},h.methods[d]=_.extend(h.methods[d]||{},{enabled:a}),i.set("methods",s),i.logChanges(h),t.render()},setUnloadConfirmation:function(){this.needsUnloadConfirm=!0,d.removeAttr("disabled")},clearUnloadConfirmation:function(){this.needsUnloadConfirm=!1,d.attr("disabled","disabled")},unloadConfirmation:function(e){if(e.data.view.needsUnloadConfirm)return e.returnValue=o.strings.unload_confirmation_msg,window.event.returnValue=o.strings.unload_confirmation_msg,o.strings.unload_confirmation_msg},updateModelOnChange:function(o){var t=o.data.view.model,n=e(o.target),i=n.closest("tr").data("id"),s=n.data("attribute"),d=n.val(),a=_.indexBy(t.get("methods"),"instance_id"),h={};a[i][s]!==d&&(h.methods[i]={},h.methods[i][s]=d,a[i][s]=d),t.logChanges(h)},updateModelOnSort:function(e){var o=e.data.view.model,t=_.indexBy(o.get("methods"),"instance_id"),n={};_.each(t,function(e){var o=parseInt(e.method_order,10),s=parseInt(i.find('tr[data-id="'+e.instance_id+'"]').index()+1,10);o!==s&&(t[e.instance_id].method_order=s,n.methods=n.methods||{methods:{}},n.methods[e.instance_id]=_.extend(n.methods[e.instance_id]||{},{method_order:s}))}),_.size(n)&&o.logChanges(n)},onConfigureShippingMethod:function(o){var t=e(this).closest("tr").data("id"),n=o.data.view.model,i=_.indexBy(n.get("methods"),"instance_id")[t];if(!i.settings_html)return!0;o.preventDefault(),e(this).WCBackboneModal({template:"wc-modal-shipping-method-settings",variable:{instance_id:t,method:i},data:{instance_id:t,method:i}}),e(document.body).trigger("init_tooltips")},onConfigureShippingMethodSubmitted:function(t,i,s){"wc-modal-shipping-method-settings"===i&&(p.block(),e.post(n+(n.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zone_methods_save_settings",{wc_shipping_zones_nonce:o.wc_shipping_zones_nonce,instance_id:s.instance_id,data:s},function(t,n){"success"===n&&t.success?(e("table.wc-shipping-zone-methods").parent().find("#woocommerce_errors").remove(),t.data.errors.length>0&&p.showErrors(t.data.errors),_.size(p.model.changes)?p.model.save():p.model.onSaveResponse(t,n)):(window.alert(o.strings.save_failed),p.unblock())},"json"))},showErrors:function(o){var t='<div id="woocommerce_errors" class="error notice is-dismissible">';e(o).each(function(e,o){t=t+"<p>"+o+"</p>"}),t+="</div>",e("table.wc-shipping-zone-methods").before(t)},onAddShippingMethod:function(t){t.preventDefault(),e(this).WCBackboneModal({template:"wc-modal-add-shipping-method",variable:{zone_id:o.zone_id}}),e(".wc-shipping-zone-method-selector select").change()},onAddShippingMethodSubmitted:function(t,i,s){"wc-modal-add-shipping-method"===i&&(p.block(),e.post(n+(n.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zone_add_method",{wc_shipping_zones_nonce:o.wc_shipping_zones_nonce,method_id:s.add_method_id,zone_id:o.zone_id},function(e,t){"success"===t&&e.success&&(e.data.zone_id!==o.zone_id&&(o.zone_id=e.data.zone_id,window.history.pushState&&window.history.pushState({},"","admin.php?page=wc-settings&tab=shipping&zone_id="+e.data.zone_id)),_.size(p.model.changes)?p.model.save():(p.model.set("methods",e.data.methods),p.model.trigger("change:methods"),p.model.changes={},p.model.trigger("saved:methods"))),p.unblock()},"json"))},onChangeShippingMethodSelector:function(){var o=e(this).find("option:selected").data("description");e(this).parent().find(".wc-shipping-zone-method-description").remove(),e(this).after('<div class="wc-shipping-zone-method-description">'+o+"</div>"),e(this).closest("article").height(e(this).parent().height())},onTogglePostcodes:function(o){o.preventDefault();var t=e(this).closest("tr");t.find(".wc-shipping-zone-postcodes").show(),t.find(".wc-shipping-zone-postcodes-toggle").hide()}}),r=new c({methods:o.methods,zone_name:o.zone_name,zone_toll:o.zone_toll,zone_extra_fee:o.zone_extra_fee}),p=new l({model:r,el:s});p.render(),s.sortable({items:"tr",cursor:"move",axis:"y",handle:"td.wc-shipping-zone-method-sort",scrollSensitivity:40})})}(jQuery,shippingZoneMethodsLocalizeScript,wp,ajaxurl);